(define GPIO_0 #xE0028000) ; IO0 port 
(define GPIO_1 #xE0028010) ; IO1 port 
(define IOPIN #x00)  ; IOxPIN register offset
(define IOSET #x04)  ; IOxSET register offset
(define IOCLR #x0C)  ; IOxCLR register offset
(define IODIR #x08)  ; IOxDIR register offset

;; Timer0 base register port
(define TIMER0 #xE0004000)
(define TIMER1 #xE0008000)
;; Timer offsets
(define TxIR #x00)
(define TxTCR #x04)
(define TxTC #x08)
(define TxPR #x0C)
(define TxPC #x10)
(define TxMCR #x14)
(define TxMR0 #x18)
(define TxMR1 #x1C)
(define TxMR2 #x20)
(define TxMR3 #x24)
(define TxCCR #x28)
(define TxCR0 #x2C)
(define TxCR1 #x30)
(define TxCR2 #x34)
(define TxEMR #x3C)
(define TxCALLBACK #x010000) ;; Special value that does not really write to a register but sets a callback

;NOTES
(define (freq dist)
  (* 440 (expt 2 (/ dist 12))))

(define sol3 (freq -14))
(define sols3 (freq -13))
(define la3 (freq -12))
(define sib3 (freq -11))
(define si3 (freq -10))
(define do4 (freq -9))
(define dos4 (freq -8))
(define re4 (freq -7))
(define mib4 (freq -6))
(define mi4 (freq -5))
(define fa4 (freq -4))
(define fas4 (freq -3))
(define sol4 (freq -2))
(define sols4 (freq -1))
(define la4 (freq 0))
(define sib4 (freq 1))
(define si4 (freq 2))
(define do5 (freq 3))
(define dos5 (freq 4))
(define re5 (freq 5))
(define mib5 (freq 6))
(define mi5 (freq 7))
(define fa5 (freq 8))
(define fas5 (freq 9))
(define sol5 (freq 10))
(define sols5 (freq 11))
(define la5 (freq 12))
(define sib5 (freq 13))
(define si5 (freq 14))

; Function to set a pin  direction on a gpio port
(define (set_output port pin)
  (let ((old_direction (read port IODIR))
        (set_pin (ash 1 pin)))
    (write 
     (logior old_direction set_pin) port IODIR)))

; function to set a pin on a gpio port
(define (set-pin port pin)
  (write (ash 1 pin) port IOSET))

; function to clear a pin on a gpio port
(define (clear-pin port pin)
  (write (ash 1 pin) port IOCLR))

(define (stop-timer)
  (write 0 TIMER1 TxTCR))

(define (start-timer)
  (write #b10 TIMER1 TxTCR) ;; Reset timer
  (write #b01 TIMER1 TxTCR)) ;; run timer

; set up the timer
(define (setup-timer delay)
  (write 0 TIMER1 TxTCR) ;; Disable for safe setting up
  (write 59 TIMER1 TxPR) ;; us
  (write delay TIMER1 TxMR0) ;; set delay
  (write #b11 TIMER1 TxMCR) ;; Interrupt and reset on MR0
  (write blinkcb TIMER1 TxCALLBACK)) ;; Set callback

(define globblink #t)
(define (blinkcb)
  (if globblink
      (set-pin GPIO_0 6)
      (clear-pin GPIO_0 6))
  (set! globblink (not globblink)))

(set_output GPIO_0 6)

; MAKING AND PLAYING TONES
;---------------------------

(define (tone freq)
  (round (/ 1000000
            freq)))

(define (tone.play tone len)
  (display "Playing tone with delay ")
  (display tone)
  (display " for ")
  (display len)
  (display " us.")
  (newline)
  (setup-timer tone)
  (start-timer)
  (wait-us (round len))
  (stop-timer))

; MAKING AND PLAYING NOTES
;---------------------------

(define pause 'pause)

(define (note tone duration)
  (cons tone duration))

(define (@note.tone note)
  (car note))

(define (@note.duration note)
  (cdr note))

(define (note.play note tempo)
  (if (eq? (@note.tone note) pause)
      (wait-us (round (/ (@note.duration note) tempo)))
      (tone.play (@note.tone note) (/ (@note.duration note) tempo))))

; MAKING AND PLAYING SONGS
;--------------------------

(define (song-play lst tempo)
  (if (null? lst)
      'done
      (begin (note.play (car lst)
                        tempo)
             (song-play (cdr lst)
                        tempo))))

(define popcorn (list (note (tone do5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone mib4) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone do4) 50000)
(note pause 150000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone mib4) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone do4) 50000)
(note pause 150000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sols4) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 150000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone mib4) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone do4) 50000)
(note pause 150000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone mib4) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone do4) 50000)
(note pause 150000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 150000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 150000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 150000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone sib5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone sib5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 150000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 150000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 150000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone sib5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone sib5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 150000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone mib4) 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone do4) 50000)
(note pause 200000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone mib4) 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone do4) 50000)
(note pause 200000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone do5) 33333)
(note (tone re5) 33333)
(note (tone do5) 33333)
(note (tone re5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sols4) 50000)
(note (tone do5) 50000)
(note pause 150000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone mib4) 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone do4) 50000)
(note pause 200000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone mib4) 50000)
(note (tone sol4) 50000)
(note pause 50000)
(note (tone do4) 50000)
(note pause 200000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone do5) 33333)
(note (tone re5) 33333)
(note (tone do5) 33333)
(note (tone re5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone do5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note (tone mib5) 50000)
(note pause 150000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 200000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 200000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone sib5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note (tone sib5) 50000)
(note pause 50000)
(note (tone sib5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note (tone sol5) 50000)
(note pause 150000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 200000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sib4) 50000)
(note (tone mib5) 50000)
(note pause 50000)
(note (tone sol4) 50000)
(note pause 200000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone sib5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note (tone sib5) 50000)
(note pause 50000)
(note (tone sib5) 50000)
(note pause 50000)
(note (tone sol5) 33333)
(note (tone la5) 33333)
(note (tone sol5) 33333)
(note (tone la5) 50000)
(note pause 50000)
(note (tone la5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note (tone sol5) 50000)
(note pause 50000)
(note (tone fa5) 50000)
(note (tone re5) 50000)
(note pause 50000)
(note (tone re5) 50000)
(note (tone fa5) 50000)
(note pause 50000)
(note (tone sol5) 50000)
(note pause 300000)
(note pause 50000)))
